name: Update AUR Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to'
        required: true
        type: string
      sha256:
        description: 'SHA256 checksum of the .deb file'
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version to update to'
        required: true
        type: string
      sha256:
        description: 'SHA256 checksum of the .deb file'
        required: true
        type: string

permissions:
  contents: write
  
jobs:
  update-aur:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify secret is available
        run: |
          if [ -z "${{ secrets.AUR_SSH_PRIVATE_KEY }}" ]; then
            echo "❌ ERROR: AUR_SSH_PRIVATE_KEY secret is not available!"
            exit 1
          else
            echo "✅ AUR_SSH_PRIVATE_KEY secret is available"
          fi
          
      - name: Setup SSH for AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Guardar la clave SSH (preservando saltos de línea)
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          # Agregar host conocido
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # Configurar SSH
          cat > ~/.ssh/config <<EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config
          
          # Verificar que la clave se guardó correctamente
          echo "🔍 Verificando configuración SSH..."
          ls -la ~/.ssh/
          echo "🔑 Primeras líneas de la clave:"
          head -n 1 ~/.ssh/aur
          
      - name: Configure git
        run: |
          git config --global user.name "SIGTERM"
          git config --global user.email "me@sigterm.vodka"
          
      - name: Update package files
        env:
          NEW_VERSION: ${{ inputs.version }}
          NEW_SHA256: ${{ inputs.sha256 }}
        run: |
          set -e
          
          REPO_OWNER="egoist"
          REPO_NAME="chatwise-releases"
          PACKAGE_NAME="chatwise"
          AUR_REPO="ssh://aur@aur.archlinux.org/chatwise.git"
          
          echo "📝 Actualizando PKGBUILD a versión ${NEW_VERSION}..."
          sed -i "s/^pkgver=.*/pkgver=${NEW_VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${NEW_SHA256}')/" PKGBUILD
          
          echo "📝 Generando .SRCINFO..."
          cat > .SRCINFO <<EOF
          pkgbase = ${PACKAGE_NAME}
          	pkgdesc = The second fastest AI chatbot
          	pkgver = ${NEW_VERSION}
          	pkgrel = 1
          	url = https://chatwise.app/
          	arch = x86_64
          	license = LicenseRef-proprietary
          	depends = cairo
          	depends = gdk-pixbuf2
          	depends = glib2
          	depends = gtk3
          	depends = hicolor-icon-theme
          	depends = libsoup
          	depends = pango
          	depends = webkit2gtk-4.1
          	depends = openssl
          	depends = libappindicator-gtk3
          	options = !strip
          	options = !debug
          	source = https://gh-releases.chatwise.app/${REPO_OWNER}/${REPO_NAME}/v${NEW_VERSION}/ChatWise_${NEW_VERSION}_amd64.deb
          	sha256sums = ${NEW_SHA256}
          
          pkgname = ${PACKAGE_NAME}
          EOF
          
          echo "✅ Archivos actualizados"
          
      - name: Commit to GitHub
        run: |
          if git diff --quiet; then
              echo "✅ No hay cambios en GitHub"
          else
              git add PKGBUILD .SRCINFO
              git commit -m "Update to version ${{ inputs.version }}"
              
              # Detectar el branch actual y hacer push
              CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
              git push origin "$CURRENT_BRANCH"
              echo "✅ Cambios guardados en GitHub (branch: $CURRENT_BRANCH)"
          fi
          
      - name: Push to AUR
        run: |
          set -e
          
          AUR_REPO="ssh://aur@aur.archlinux.org/chatwise.git"
          
          echo "📥 Clonando repositorio AUR..."
          git clone "$AUR_REPO" aur-repo
          
          cd aur-repo
          
          cp ../PKGBUILD .
          cp ../.SRCINFO .
          
          if git diff --quiet; then
              echo "✅ No hay cambios para el AUR"
              exit 0
          fi
          
          echo "📤 Publicando cambios al AUR..."
          git add PKGBUILD .SRCINFO
          git commit -m "Update to version ${{ inputs.version }}"
          git push origin master
          
          echo "✨ ¡Paquete publicado en AUR versión ${{ inputs.version }}!"

